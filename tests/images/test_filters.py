
import logging
logging.basicConfig(level=logging.DEBUG,format='%(name)s - %(levelname)s - %(message)s', datefmt='%m/%d/%Y %I:%M:%S %p')

from glob import glob
import lzma
import tempfile
import os
import hashlib
import stegoveritas
from stegoveritas.modules.image import SVImage

SCRIPTDIR = os.path.dirname(os.path.realpath(__file__))

def test_filters_general():

    # Just enumerating an expected run for now
    expected_hashes_bionic = ['c35aa2a15d7dbb4d0babc40010c7ee90095e7a19fb9701845207f0cdb7d444ac', '217b46ff1e44859c4ae581cabbd398de0f0c6475379f408727d19cd6ef666f2f', 'ff7d7f737e28be5f3450272205976766c323f88916148e4214cca64d59ef5a82', 'fc505985fe2290a2b4aedad4267e10a54a69727ad2238581f22c76d414732cfd', '96b968a62142498d41288100d93e6090b85cc85d0bb61373399130293137ac31', 'c586a04084a5d311cf9947138b765b40f91e2f62c09f8fb71ab62e31abc08812', 'd00aadadd2f8d6b66c114e1cb393ac6bcb029bbb9d8ca59b9e00c65b48a81cb7', '2fd60df6285a8cd850f2e302ea8486bfbd0560aed7bc02270ce2e5cf5b7beb1a', '87a065c6d1f4cf5f7e1c39081f291c9dfcc615685169d6dc24056a320603acec', '84d829c3a27c7b86331029b0ccfd3a744a258f956f8b3420345963d451a32128', '3cdb1f23dde9c46a3234bc0329216e847f3406fb1ce40efcad1437e529602533', '8f8bf6afafe5f910cc025657055cf4846550b0c9da4ac9c2331c5e34643a0103', '6964ad9716775db61dc74133646cc7426196266bd069fd7da72dbbf31e045838', '6a1f326e969c759799186c01d25d4785cff8fde900728df54f7aab8db5b9dc13', '1d089027b26bf06f76a013fcdc5adae48c71c3e1dd76c1d010771586a87d9347', '35deb8274ff3795275e687848cb8608a8c6aae04d2ed3b10e75c7b956ce0dce2', '7c636d0ce2db36ecfea92fadb4cf678e5226de47c222c25d20640b7496da876f', '72eebe8abaa3b71dd5c5beef0ee45990d56035de557fff54eb7938f1d962bb4c', '3147f3466659f909c30d9691cbed79e0aa93ba7f31cc3de074e3e2c07d7299e8', '1b218642c748f26c4ff7e9993bb8e33ccda1d5cff6cc4c8a5182e3074ea2a146', '99fdc34851cee61dc241176609ece8ef3cb275fc12d704fa28b78aa3532eecb9', 'd81faa671760e1d82c37798330256592e4fc63786e590146ea188f3294075421', 'a654192cd53ffd001c1fbf212d0397fa035b704b0bd88cfd2cac0609a46992ca', '3551bcdb88a63d5d9dd78c649ff4358fb7bd60a1f8a217f81e0f88b6e2082238', 'e87c13762895f46bc378face7f1cbf88e1b15b957d0be35beb7100adbf60d893', '4ce36f55619b1158b4d46cb0f5b3a3ca7d36b8ffd58b96ee02f3745e0285bcc7', 'cbb35153f7423c228ce0f65f807c1c6fa5216801d0fb9f83ede83831277a952f', 'bb5f212d229b2d62146e54a1536f8e00bee36f33c6600ead7aa55c0863df7a40', '1b5b9903efb09541d0e4f3d81ccee203015392ad039d510f0cbb2dab82ecd880', '7ca76b39e0677cda05f3b763c0f5413d394a2a263444dc203a1bfec24a1c7ee3', '33782a4ea7b516d4be6084bba99974cdc01651a0e0dde47bae7e19b94c113fcd', 'e82ac6c7cbd727323e0a7e5fc365d3a93226e132a05fa2c9c1fbe7429c2ef4dc', '30d6055cc8585a1e99d24c14adf0b4901623d2c9c32d9941eceb6272a0f232c1', '16c4822cbcacc29ff4e3f16d6914eb0bb545f2a9b0d990eaed1d52a97452701f', 'a8646064368becf884c7b4f2eb415222a07b8986564ec85588b91eb2b581f284', 'b403509bb2cde5e1b1e12430e07748479aeb6fd7d138365025bc2045c0dcc1f6', '8e2cca5767003620e98041c85e015a922fce507186f3177ab7e29eabf0c96e85', '3da5482c874a55612b076ada6838eadf43308b3a5c9b4655c3714a695398e991', '6fa524057dca871f1cd21e2ea0eefe483ce2757165a133c8306b74a893f32ea9', 'ca30249c54febb404d1b9a17fb5dbdb513f1caf66d0ee2265c66b6004f0f78e3', '4810712f350d70db6a790c94ef26f52ad3ee8a54ec9a7094b0d5b1ce10f2112a', '77ba4e421659b6b63914322d46b09c9b6ee23f51edcfb5d8896908e2d49fc297', 'cdcb907bebdb380e78bde7124395b2a0baca70f059efdc194a9682cdef4a9ca5', 'e3059a40e602dff9f4f69c8ce7feb0361f1955a5e9b8fc0fad5d8b9f95ad2281', '8573391d1e120c5019f65179de4ba151726e318b576005849ed38c20cf1e0b9a', '503064845994c887becb0c77bd0acddc12a4bcfa946ae6069e6766c7845d6675', 'e54561142396959e4e341967b5b6b4b66a8b637a08fa91999ac2b7e00853fa78', 'ffc8b494dfad0793cab88da00fff671527f461ee5e23e035e9ac166ecbbc958d', '135b0a8c0dc2e770419675657b7cb02077d8cc1c28e108d778d17679c5058873', '7dcaf947264e16fd7959b4ab3c23674c87b44bb2fc873a205e84ac6719b4ae4c']
    expected_hashes_focal = ['1316214839491bb8179e33ee34bf0ab6a0dca15e70e17f01f03f45e2621165c7', 'e3ad776b300155b2679540f899a22081798de8aa25c48b20fb77e05128a9f345', 'ca5235f2e0ba80385cac6c32ddca4ee0fe5d53c7aad01890360583ddd7f36ea9', 'bf100bb1060140afb6111bd799fc33a4da46e54abcf002278d1443bdeca7f136', 'a75ec24cb6b920267c068692996f6fd8bf58833f1285fb495ea122b1cbae909a', 'cc9e946df2c262399a7360dc804c7b1ea5101365332bcc087572022530029829', 'a4fae08df6aec73079c46af47e4d7a7317793dd3315e718dae877765ab92cf5d', 'dff428226df64a1a50cedd33f10cc971e501c50be257bca034a02a6747ad4e1b', 'a12c9657bb3cfe0ceacc9e2dbce8e92e6eb0d95276fb7d70b8c31de58450b417', '1370990bed8339fd8fbfee952c69375b6e37d3ecce206c457234f18d03080ee0', '93e36f0b614c11d6e309e418437aa8e44dfa323c3c84336294cd03759d49ac95', 'd13619ef03558f8deee1e9feaa392207053a946595552da257ea363deda7e7d4', 'c0a42d929203e3c7cdb523cb74ee2f6ff912fbe57632d1a1f11e3cd0619217c3', 'e748180e36904c39248ccc7ba9166372ca9dba609ff83fd2bc9811591abc445c', '9b16b447c7670ce94dd937e8dd3baf8ca07fbc090fa65ef19643ed61108ad454', '469fe69110c6bad9efd534e0245a49dd49fcbdcef3884b2efcad817945f75872', '4a943b9b752895e6c2a2fee9844492b352c2a04dcbb04b1ea6a2e40a06c80bf0', 'e98ef8bf60c437b69327338bd5d8131438327fd4297d87b0d990ad42e426e0bc', 'ef09ae2f49a56f1817e8951f8a014886c92b7e6b537b0c0bad0dc9cf407098d4', '7ae4e5ba5e767e7a081205f0c42d7ee6949c29664d96e84ac0d864cccdddc84c', '768bf0c70b419a80d61bcad56df706f77f506b7736def06aeb4afcd4c0d00bd0', '9f516e3e02254049de7142af34965e3dae97973f9b3617ffde819d23ee48b94a', 'b7475e6fc3dd43c6d03b168c89298679709bf9c12767c70dea5e7da6c5726381', '66df5fd6697347c6212ede84d20ddc78d84638f59526bc4942cd4c744a840963', '42bae24ed615938a04214c0a6c7181bbaacb5c0ad9bec2b2dc11ac4198477598', '30201c76a4368085e65ea81e05afa30962a128aeaab98dc2f856770b0e799958', 'a0dd9b6cc077e74191f3d577fd6adcec09bf472eef31b4949359ce854bbddba1', '2197da2e4b9c734163410d6cc43fd21a804114c85720b6a32a239f2e13a7bbe6', '4ed33ecda2a85daed1a82073a341b0ed0341ef532835160509c5bda350fc667e', '865d48560a70e9592a6e6d6b9deaae747e50d5e81d4ab01f88d6274cf04b38fc', '64522bacb4664278be958420713a4f087046fa8b2cfb3088805c048108889cd1', 'd277028c66924aa5ecba2e9cd10b40c9ca711b65af81bf1ee918ace493a5fb30', '03226dcdebf007c3ffd29ffa61134bc689e82231b509a861541bc5cbf0ff2540', '4cf35b92de8872cb78a3ef7986df55677174376e767fdbd01968acd8b05310e0', 'aff4ef013647fce1c4c64e2b184a16fa5539ebfc61a26c430bd4cd515b340934', '91a067722f7244d3f59cf4d7a9e137b57c4d8686ac34bd4bf959c8738bfa43b0', '70c46642d3c0538d37da63ce13241b82a788d1ad3c0364101054fcc0594d7f1c', '9b521ace279b8a1aa787b8bade5bfd8dbe270b44f053007031d8ddb987ba3501', '1faa14857a263be011111d8eeab2ddabd2ea241bd3768d82ceee76a2489d9111', '0bb5a2a28140b675df4559bd25ab3489217771b90828371296b4083ec3dca5d3', '6e6504fd86cec532ed676f65eb232ab0aca476979b56e41663a43e8ff66f4883', 'ac5663485a44ae81e531dec0613fe5d8454f4cf0c87878065813699f3f3b22db', 'c2865258f5d86aae102a7add3c14e510febefdc5a86f2c3a0526b69ca8a0c924', '65348d0f4c065cd3b9d328cab1b5a0cc757f444d49f43b9608f2b6b4e03b887a', '24cb3dd7d78abf29a406c2514c1d2dcfcd9f992b71f7f57473020596cfe1575f', 'da3e52bb95589ec4de7760ec0dcadc10e993e20f609662b0731fe421a76449ae', '19b6b00bc9bfb9e21e893c382d444a690ee997c0963eab6d3b4e523e63efa189', '43cba4620b760dda5eccc4e7f161fe20a94dd3095fe5394fbdd1e576dfc0ccc2', 'a2463600bb9d3ecace75b4c48706cde733b4ae43a6e97ddd03d025e0f995b3f0', '8ccf564234200bd40e868d7f9118081b9383ddb186127cef11ae4d4171e2265a']
    expected_hashes = expected_hashes_bionic + expected_hashes_focal

    with tempfile.TemporaryDirectory() as tmpdirname:  
        args = [os.path.join(SCRIPTDIR, 'owl_nosteg.jpg'), '-out', tmpdirname, '-imageTransform'] 
        veritas = stegoveritas.StegoVeritas(args=args)
        veritas.run()

        _, _, files = next(os.walk(tmpdirname))

        for f in files:
            assert SVImage.hash_file(os.path.join(tmpdirname, f)) in expected_hashes

def test_filters_truncated_image():

    with tempfile.TemporaryDirectory() as tmpdirname:  

        with lzma.open(os.path.join(SCRIPTDIR, 'pico2018-special-logo.bmp.xz'), "rb") as f:
            with open(os.path.join(tmpdirname, 'pico2018-special-logo.bmp'), "wb") as g:
                g.write(f.read())

        args = [os.path.join(tmpdirname, 'pico2018-special-logo.bmp'), '-out', tmpdirname, '-imageTransform'] 
        veritas = stegoveritas.StegoVeritas(args=args)
        veritas.run()

        assert len(glob(os.path.join(tmpdirname, "*"))) > 3
